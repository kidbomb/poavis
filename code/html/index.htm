<html>
  <head>
	<title>PoaVis</title>
	<style>
		.map {   
			height: 700px;
			width: 700px;
		}
		.rounded {
			border-radius: 8px;
			-moz-border-radius: 8px;
			-webkit-border-radius: 8px;
			-khtml-border-radius: 8px; 
		}
		body, td{
			font-family:Arial;
			font-size: 12px;
		}
	</style>
	<link rel="stylesheet" href="css/themes/base/jquery.ui.all.css">
	<link rel="stylesheet" media="screen" type="text/css" href="css/colorpicker.css" />

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
	<script type="text/javascript" src="js/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/jquery/ui/jquery.ui.map.js"></script> 
	<script type="text/javascript" src="js/jquery/ui/jquery.ui.map.overlays.js"></script>
	<script type="text/javascript" src="js/colorpicker.js"></script>
	<script type="text/javascript">

		//does not work as a property; why is that?
		var nearest_bus_stops =  new Array();
		//creating layers by hands is lees error- prone
		//weird behavior with geometries and inverted latlng

		FusionTablesConfig = function()
		{
			this.url = "https://www.googleapis.com/fusiontables/v1/query?sql=";
			this.key = "AIzaSyDzCqo28pFaXthYWbHulJWwg08416pd_xQ";
		}
	
		LineService = function()
		{
			this.config = new FusionTablesConfig();
			this.table_lines = "14QM1T-uEiWyA805KWvriwxvyZ-fAEDWlATABxJA";
		}
		LineService.prototype.getLines = function(callback)
		{
			$.getJSON(this.config.url
					+'SELECT linha_id, onibus_id, nome,sentido'
					+' FROM ' + this.table_lines
					+"&key="+this.config.key, callback);
		}
		
		LineService.prototype.getLineGeometry = function(line_id, callback)
		{
			$.getJSON(this.config.url
					+'SELECT geometria'
					+' FROM ' + this.table_lines
					+' WHERE linha_id = '+line_id
					+"&key="+this.config.key, callback); 
		}

		BusStopService = function()
		{
			this.config = new FusionTablesConfig();
		}
		

		BusStopService.prototype.getNearestBusStops = function(latlng, radius, callback)
		{
				$.getJSON(this.config.url
					+'SELECT geo,parada_id'
					+' FROM 1lKFJZk19sczADdgx3kVE2uFEd_p-dcUFIbusVWg'
					+' WHERE ST_INTERSECTS(geo, CIRCLE(LATLNG('+latlng.lat()+','+ latlng.lng() +'),'+ radius +'))'
					+"&key="+this.config.key, callback); 

		}

		BusStopList = function()
		{
		}

		BusStopList.prototype.createRow = function(line)
		{
				var new_row = '<tr>'
                        	+ '<td style="background-color:#EEE; border:1px solid #CCC">'
                            + '<table style="width:280px">'
                            	+'<tr>'
                                	+'<td>'
                                    + line.name
                                    +'</td>'
									+'<td style="background-color:'+line.color
									+';border:1px solid #CCCCCC;cursor:pointer;width:20px;" id="line_'+ line.line_id +'">'
                                    +'<div id="colorpicker_'+line.line_id+'"&nbsp;</div>'
                                    +'</td>'
                                +'</tr>'
                            +'</table>'
                            +'</td>'
                    	+'</tr>';
					
				$("#linhasTable > tbody:last").append(new_row);
				$("#line_"+line.line_id).click(this.onRowClicked);

				$('#colorpicker_'+line.line_id).ColorPicker({
					flat: true,
					color: line.color,
					onSubmit: function(hsb, hex, rgb) {
						line.path.setOptions({strokeColor:"#" + hex});
						$('#colorpicker_'+line.line_id+'>div').hide();
						$('#line_'+line.line_id).css('background-color', '#' + hex);
					}
				});
				$('#colorpicker_'+line.line_id+'>div').css('position', 'absolute');
				$('#colorpicker_'+line.line_id+'>div').css('z-index', '2');
				$('#colorpicker_'+line.line_id+'>div').hide();
		}

		BusStopList.prototype.onRowClicked = function()
		{
			line_id = $(this).attr('id').substr(5);
			$('#colorpicker_'+line_id+'>div').show();
		}
		

		Line = function()
		{
			this.line_id = "";
			this.name = "";
			this.sentido = "";
			this.path = null;
			this.color = "";
			this.service = new LineService();
		}
		
		Line.prototype.draw = function(map_canvas){
			var coordinates = new google.maps.MVCArray();
			
			_this = this;
			this.service.getLineGeometry(line_id, function(data){
   				var latlngbounds = new google.maps.LatLngBounds();
				
				var points = data.rows[0][0];
				$.each(points.geometry.coordinates, function(i,point){
   					var coordinate = new google.maps.LatLng(point[1], point[0]);
					coordinates.push(coordinate);
					latlngbounds.extend(coordinate);
   				});
				
   				map_canvas.fitBounds(latlngbounds);
				
				_this.path = new google.maps.Polyline({
   					path: coordinates,
		   	   		strokeColor: _this.color,
   	   				strokeOpacity: 0.7,
		   	   		strokeWeight: 3
		   		});

				_this.path.setMap(map_canvas);

			});
		}

		function BusStop()
		{
			this.marker = null;
		}
		
		function PoaVisMain()
		{
			this.lines_cache = {};
			this.lines = {};
			this.available_colors = ['#FF0000', '#00FF00', '#0000FF'];
			this.next_available_color = 0;
			this.service = new LineService();
			this.bus_stop_service = new BusStopService();
			this.bus_stop_list = new BusStopList();
		}
		
		PoaVisMain.prototype.initializeMap = function(){
			$('#map-canvas').gmap({'center':'-30.13206313822174,-51.107025146484375', 'zoom':11});
			$('#map-canvas').gmap().bind('init', function(ev, map) {
			});
			
			this.map_canvas = $('#map-canvas').gmap('get', 'map'); 
		}
		
		PoaVisMain.prototype.getNextAvailableColor = function(){
			if(this.next_available_color >= this.available_colors.length){
				this.next_available_color = 0;
			}
			next_color = this.available_colors[this.next_available_color++];
			return next_color;
		}
		
		
		PoaVisMain.prototype.cacheLines = function(){
			var _this = this;
			this.service.getLines(function(data) {
				$.each(data.rows, function(index, value){
					line_id = value[0];
					name = value[2];
					sentido = value[3];

					_this.lines_cache[line_id] = new Line();
					_this.lines_cache[line_id].name = name;
					_this.lines_cache[line_id].sentido = sentido;
				});
			});
		}
		
		PoaVisMain.prototype.setupPlacesAutocomplete = function(){
			var input = document.getElementById('searchTextField');
			var marker = new google.maps.Marker({
          		map: this.map_canvas
			});

	        var autocomplete = new google.maps.places.Autocomplete(input);
    	    autocomplete.bindTo('bounds', this.map_canvas);
			var _this = this;

        	google.maps.event.addListener(autocomplete, 'place_changed', function() {
  				_this.onMapPlaceChanged(autocomplete, marker);
			});
		}

		PoaVisMain.prototype.onMapPlaceChanged = function(autocomplete, marker)	{
         	var place = autocomplete.getPlace();
          	if (place.geometry.viewport) {
           		this.map_canvas.fitBounds(place.geometry.viewport);
	        } else {
    	       	this.map_canvas.setCenter(place.geometry.location);
        	    this.map_canvas.setZoom(16);  // Why 16? Because it looks good.
          	}

	        marker.setPosition(place.geometry.location);

    	   	var address = '';
         	if (place.address_components) {
           		address = [
         	  		(place.address_components[0] && place.address_components[0].short_name || ''),
	        	   	(place.address_components[1] && place.address_components[1].short_name || ''),
            		(place.address_components[2] && place.address_components[2].short_name || '')
     	    	].join(' ');
			}
		}
		
		PoaVisMain.prototype.setupLinesAutocomplete = function(){
			var _this = this;
			$( "#linhas" ).autocomplete({   
				source:  function(request, response) {
					var ac_response = []
					$.each(_this.lines_cache, function(line_id, line){
							if(request.term.length >=2 && line.name.toLowerCase().indexOf(request.term.toLowerCase()) != -1){
								text = line.name + " - Sentido " + line.sentido;
								ac_response.push({label:text, value:"", id:line_id});
							}		
					});
					response(ac_response);
				},
				select: function( event, ui ) {
					line_id = ui.item.id;
					
					_this.lines[line_id] = new Line();
					_this.lines[line_id].color = _this.getNextAvailableColor();
					_this.lines[line_id].line_id = line_id;
					_this.lines[line_id].name = _this.lines_cache[line_id].name;
					_this.lines[line_id].sentido = _this.lines_cache[line_id].sentido;
					_this.lines[line_id].draw(_this.map_canvas);

					_this.bus_stop_list.createRow(_this.lines[line_id]);

					//TODO: 
					//status when loading line
				}		
			});
		}
		
		PoaVisMain.prototype.getNearestBusStops = function (latlng){
			_this = this;
			this.bus_stop_service.getNearestBusStops(latlng, 500, function(data){
				$.each(data.rows, function(i,row){
					point=row[0].split(",");
					parada_id = row[1];
					var coordinate = new google.maps.LatLng(point[0], point[1]);
					new_marker = new google.maps.Marker({
						    	position: coordinate,
								icon:  "http://storage.googleapis.com/support-kms-prod/SNP_2752125_en_v0",
						    	map: _this.map_canvas
					});
					nearest_bus_stops.push(new_marker);
				});
			});
		}

		PoaVisMain.prototype.clearNearestBusStops = function(){
			for(i in nearest_bus_stops)
			{
				nearest_bus_stops[i].setMap(null);
				//TODO:remove from dictionary
			}

		}

		$(function() { 

			$("#visualizarParadas").hide();

			var poaMap = new PoaVisMain();
			
			poaMap.initializeMap();

			//create cache
			poaMap.cacheLines();

			poaMap.setupPlacesAutocomplete();

			poaMap.setupLinesAutocomplete();

			google.maps.event.addListener(poaMap.map_canvas, 'zoom_changed', function(event) {
				if(poaMap.map_canvas.getZoom() > 14){
					poaMap.getNearestBusStops(poaMap.map_canvas.getCenter());
				} else {
					poaMap.clearNearestBusStops();
				}
 			});
	});


    </script>
  </head>
  <body>
  	<table cellpadding="4">
    	<tr>
        	<td valign="top" style="border-right:1px solid #CCC">
                <table style="background-color:#EEE; border:1px solid #CCC">
                    <tr>
                      <td><label>Por linha:</label><input id="linhas" type="text" size="35" placeholder="Digite o nome de uma linha de ônibus" autocomplete="off"/></td>
                    </tr>
                    <tr>
                        <td><label>Por local:</label><input id="searchTextField" type="text" size="35" placeholder="Digite um local" autocomplete="off" />  </td>
                     </tr>
                </table>
                
                <p>Linhas</p>
                <table style="border:1px solid #CCC; width:310px" cellspacing="2" id="linhasTable">
	                <tbody>

    	            </tbody>
                </table>
            </td>
            <td rowspan="2"><div id="map-canvas" class="map rounded" style="float:left"></div></td>
			        	          
        </tr>
    </table>
    
  </body>
</html>

