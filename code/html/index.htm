<html>
  <head>
	<title>PoaVis</title>
	<style>
		.map {   
			height: 700px;
			width: 700px;
		}
		.rounded {
			border-radius: 8px;
			-moz-border-radius: 8px;
			-webkit-border-radius: 8px;
			-khtml-border-radius: 8px; 
		}
		body, td{
			font-family:Arial;
			font-size: 12px;
		}
	</style>
	<link rel="stylesheet" href="css/themes/base/jquery.ui.all.css">
	<link rel="stylesheet" media="screen" type="text/css" href="css/colorpicker.css" />

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
	<script type="text/javascript" src="js/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/jquery/ui/jquery.ui.map.js"></script> 
	<script type="text/javascript" src="js/jquery/ui/jquery.ui.map.overlays.js"></script>
	<script type="text/javascript" src="js/colorpicker.js"></script>
	<script type="text/javascript">
	
		//creating layers by hands is lees error- prone
		//weird behavior with geometries and inverted latlng
	
		FusionTablesProxy = function()
		{
			this.url = "https://www.googleapis.com/fusiontables/v1/query?sql=";
		}
		FusionTablesProxy.prototype.getLines = function(callback)
		{
			$.getJSON(this.url
					+'SELECT linha_id, onibus_id, nome,sentido '
					+'FROM 14QM1T-uEiWyA805KWvriwxvyZ-fAEDWlATABxJA&key=AIzaSyDzCqo28pFaXthYWbHulJWwg08416pd_xQ', callback)
		}
		
		FusionTablesProxy.prototype.getLineGeometry = function(linha_id, callback)
		{
			$.getJSON(this.url
					+'SELECT geometria '
					+'FROM 14QM1T-uEiWyA805KWvriwxvyZ-fAEDWlATABxJA WHERE linha_id = '+linha_id+"&key=AIzaSyDzCqo28pFaXthYWbHulJWwg08416pd_xQ", callback); 
		}
		
		FusionTablesProxy.prototype.getNearestBusStops = function(latlng, radius, callback)
		{
				$.getJSON(this.url
					+'SELECT geo,parada_id '
					+'FROM 1lKFJZk19sczADdgx3kVE2uFEd_p-dcUFIbusVWg WHERE ST_INTERSECTS(geo, CIRCLE(LATLNG('+latlng.lat()+','+ latlng.lng() +'),'+ radius 
					+'))&key=AIzaSyDzCqo28pFaXthYWbHulJWwg08416pd_xQ', callback); 
		}

		Linha = function()
		{
			this.linha_id = "";
			this.nome = "";
			this.sentido = "";
			this.path = null;
			this.color = "";
		}
		
		Linha.prototype.draw = function(fusion_tables, map_canvas){
			var coordinates = new google.maps.MVCArray();
			
			_this = this;
			fusion_tables.getLineGeometry(linha_id, function(data){
   				var latlngbounds = new google.maps.LatLngBounds();
				
				var points = data.rows[0][0];
				$.each(points.geometry.coordinates, function(i,point){
   					var coordinate = new google.maps.LatLng(point[1], point[0]);
					coordinates.push(coordinate);
					latlngbounds.extend(coordinate);
   				});
				
   				map_canvas.fitBounds(latlngbounds);
				
				_this.path = new google.maps.Polyline({
   					path: coordinates,
		   	   		strokeColor: _this.color,
   	   				strokeOpacity: 0.7,
		   	   		strokeWeight: 3
		   		});

				_this.path.setMap(map_canvas);

			});
		}

		function BusStop()
		{
			this.marker = null;
		}
		
		function PoaVis()
		{
			this.linhas_cache = {};
			this.linhas = {};
			this.available_colors = ['#FF0000', '#00FF00', '#0000FF'];
			this.next_available_color = 0;
			this.fusion_tables = new FusionTablesProxy();
			this.nearest_bus_stops = {};
		}
		
		PoaVis.prototype.initialize = function(){
			$('#map-canvas').gmap({'center':'-30.13206313822174,-51.107025146484375', 'zoom':11});
			$('#map-canvas').gmap().bind('init', function(ev, map) {
			});
			
			this.map_canvas = $('#map-canvas').gmap('get', 'map'); 
		}
		
		PoaVis.prototype.getNextAvailableColor = function(){
			if(this.next_available_color >= this.available_colors.length){
				this.next_available_color = 0;
			}
			next_color = this.available_colors[this.next_available_color++];
			return next_color;
		}
		
		
		PoaVis.prototype.cacheLines = function(){
			var _this = this;
			this.fusion_tables.getLines(function(data) {
				$.each(data.rows, function(index, value){
					linha_id = value[0];
					nome = value[2];
					sentido = value[3];

					_this.linhas_cache[linha_id] = new Linha();
					_this.linhas_cache[linha_id].nome = nome;
					_this.linhas_cache[linha_id].sentido = sentido;
				});
			});
		}
		
		PoaVis.prototype.setupPlacesAutocomplete = function(){
			var input = document.getElementById('searchTextField');
			var marker = new google.maps.Marker({
          		map: this.map_canvas
			});

	        var autocomplete = new google.maps.places.Autocomplete(input);
    	    autocomplete.bindTo('bounds', this.map_canvas);
			var _this = this;

        	google.maps.event.addListener(autocomplete, 'place_changed', function() {
          		var place = autocomplete.getPlace();
          		if (place.geometry.viewport) {
            		_this.map_canvas.fitBounds(place.geometry.viewport);
	          	} else {
    	        	_this.map_canvas.setCenter(place.geometry.location);
        	    	_this.map_canvas.setZoom(16);  // Why 16? Because it looks good.
          		}

	          	marker.setPosition(place.geometry.location);
	
    	      	var address = '';
        	  	if (place.address_components) {
            		address = [
              		(place.address_components[0] && place.address_components[0].short_name || ''),
	              	(place.address_components[1] && place.address_components[1].short_name || ''),
    	          	(place.address_components[2] && place.address_components[2].short_name || '')
        	    	].join(' ');
				}
			});
		}
		
		PoaVis.prototype.setupLinesAutocomplete = function(){
			var _this = this;
			$( "#linhas" ).autocomplete({   
				source:  function(request, response) {
					var ac_response = []
					$.each(_this.linhas_cache, function(linha_id, linha){
							if(request.term.length >=2 && linha.nome.toLowerCase().indexOf(request.term.toLowerCase()) != -1){
								text = linha.nome + " - Sentido " + linha.sentido;
								ac_response.push({label:text, value:"", id:linha_id});
							}		
					});
					response(ac_response);
				},
				select: function( event, ui ) {
				console.log("LABEL=" +  ui.item.label + "/n" + "VALUE=" + ui.item.value + "/n" + "VALUEB=" + this.value+ "/n ID = "+  ui.item.id);
					linha_id = ui.item.id;
					
					_this.linhas[linha_id] = new Linha();
					_this.linhas[linha_id].color = _this.getNextAvailableColor();
					_this.linhas[linha_id].linha_id = linha_id;
					_this.linhas[linha_id].nome = _this.linhas_cache[linha_id].nome;
					_this.linhas[linha_id].sentido = _this.linhas_cache[linha_id].sentido;
					_this.linhas[linha_id].draw(_this.fusion_tables, _this.map_canvas);
					
					var new_row = '<tr>'
                        	+ '<td style="background-color:#EEE; border:1px solid #CCC">'
                            + '<table style="width:280px">'
                            	+'<tr>'
                                	+'<td>'
                                    + _this.linhas[linha_id].nome
                                    +'</td>'
									+'<td style="background-color:'+_this.linhas[linha_id].color
									+';border:1px solid #CCCCCC;cursor:pointer;width:20px;" id="linha_'+ linha_id +'">'
                                    +'<div id="colorpicker_'+linha_id+'"&nbsp;</div>'
                                    +'</td>'
                                +'</tr>'
                            +'</table>'
                            +'</td>'
                    	+'</tr>';
					
					$("#linhasTable > tbody:last").append(new_row);
				
					$("#linha_"+linha_id).click(function() {
						linha_id = $(this).attr('id').substr(6);
						$('#colorpicker_'+linha_id+'>div').show();
					});

					$('#colorpicker_'+linha_id).ColorPicker({
						flat: true,
						color: _this.linhas[linha_id].color,
						onSubmit: function(hsb, hex, rgb) {
							_this.linhas[linha_id].path.setOptions({strokeColor:"#" + hex});
							$('#colorpicker_'+linha_id+'>div').hide();
							$('#linha_'+linha_id).css('background-color', '#' + hex);
						}
					});
					$('#colorpicker_'+linha_id+'>div').css('position', 'absolute');
					$('#colorpicker_'+linha_id+'>div').css('z-index', '2');
					$('#colorpicker_'+linha_id+'>div').hide();

 
					

					//TODO: 
					//add to table
					//status when loading line
				}		
			});
		}
		
		PoaVis.prototype.getNearestBusStops = function (latlng){
			console.log("LAT = " + latlng.lat());
			console.log("LNG = " + latlng.lng());
			_this = this;
			this.fusion_tables.getNearestBusStops(latlng, 500, function(data){
				$.each(data.rows, function(i,row){
					point=row[0].split(",");
					parada_id = row[1];
					var coordinate = new google.maps.LatLng(point[0], point[1]);
					_this.nearest_bus_stops[parada_id] = new google.maps.Marker({
						    	position: coordinate,
								icon:  "http://storage.googleapis.com/support-kms-prod/SNP_2752125_en_v0",
						    	map: _this.map_canvas
					});
				});
			});
		}

		$(function() { 

			$("#visualizarParadas").hide();

			var poaMap = new PoaVis();
			
			poaMap.initialize();

			//create cache
			poaMap.cacheLines();

			poaMap.setupPlacesAutocomplete();

			poaMap.setupLinesAutocomplete();


			google.maps.event.addListener(poaMap.map_canvas, 'zoom_changed', function(event) {
				if(poaMap.map_canvas.getZoom() > 14){
				//$("#visualizarParadas").show();
					poaMap.getNearestBusStops(poaMap.map_canvas.getCenter());
					} else {
						for(parada_id in poaMap.nearest_bus_stops)
						{
						console.log("cleaning " + parada_id);
						console.log(poaMap.nearest_bus_stops[parada_id]);
							poaMap.nearest_bus_stops[parada_id].setMap(null);
							//TODO:destroy, remove from dictionary
						}
					}
 			});
			//visualizarParadas
			
			$("#visualizarParadas").click(function() {
				poaMap.getNearestBusStops(poaMap.map_canvas.getCenter());
			});
			
			$('#accordion').accordion();
			/*
			var menu = new Menu(map_canvas);
			menu.add('Direction to here', 'itemB',
			function(){
				alert("Test");
			});
			

			//--------------------------------------------------------------------------------------------------
			google.maps.event.addListener(map_canvas, 'rightclick', function(event) {
				current = event;
				menu.show();
 			});

*/



	});


    </script>
  </head>
  <body>
  	<table cellpadding="4">
    	<tr>
        	<td valign="top" style="border-right:1px solid #CCC">
                <table style="background-color:#EEE; border:1px solid #CCC">
                    <tr>
                      <td><label>Por linha:</label><input id="linhas" type="text" size="35" placeholder="Digite o nome de uma linha de ônibus" autocomplete="off"/></td>
                    </tr>
                    <tr>
                        <td><label>Por local:</label><input id="searchTextField" type="text" size="35" placeholder="Digite um local" autocomplete="off" />  </td>
                     </tr>
                </table>
                
                <p>Linhas</p>
                <table style="border:1px solid #CCC; width:310px" cellspacing="2" id="linhasTable">
	                <tbody>

    	            </tbody>
                </table>
            </td>
            <td rowspan="2"><div id="map-canvas" class="map rounded" style="float:left"></div></td>
			        	          
        </tr>
    </table>
    
  </body>
</html>

